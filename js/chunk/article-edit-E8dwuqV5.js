import{Q as S,S as b,U as k,V as A,z as R,c as o,j as t,a0 as E,D as j,B as l,b as w,y as F,n as I,Z as z,a1 as L,a2 as D,$ as T}from"../entry/index-HYVjuyXu.js";import{A as d,c as _,M as x,s as B,R as U,m as q,S as M,a as N}from"./article-add-nss4-SOj.js";import{g as V,p as O}from"./article-api-4y4DPcIH.js";import{c as P,s as p}from"./index-Ofe16QpN.js";import{F as u,I as g}from"./index-vkfpJKNu.js";import{S as y,g as Q}from"./cate-api-uY0erO4i.js";import{S as f}from"./index-FvAIaAj1.js";import{A as C}from"./index-FIXWjQ-h.js";import{u as W}from"./hooks-6wdiGh58.js";import{S as Z}from"./index-U1XM-2_3.js";import{M as $}from"./index-v8syB34c.js";import"./index-qWcwa-Qk.js";import"./FileTextOutlined-4w7uLBNx.js";import"./index-rOXd1mbK.js";import"./pickAttrs-XFrlQ5-n.js";import"./EyeOutlined-9LXoceyI.js";import"./collapse-as1LdTNY.js";import"./DownOutlined-Lu0pb220.js";const G={article:{},current:d.base},i=S()(b(k(A(()=>({...G}),{name:"art-edit-store",storage:_(),partialize(e){return{article:e.article}}}),{name:"art-edit-store"}))),H=async e=>{try{const r=await V(e);i.setState(s=>{r.data&&(s.article=r.data)})}catch{return null}return!0},J=e=>{i.setState(r=>{r.article={...r.article,...e}})},m=(e=x.next)=>{i.setState(r=>{r.current+=e})},K=()=>{i.setState(e=>{e.current=d.base})},X=e=>{i.setState(r=>{r.article.cover_img=e})},Y=e=>{i.setState(r=>{r.article.content=e})},ee=e=>{i.setState(r=>{r.article.state=e})},te=e=>e.current,re=e=>({title:e.article.title,cate_id:e.article.cate_id}),se=e=>{const r=e.article.cover_img;return r?typeof r=="string"?P.baseURL+r:URL.createObjectURL(r):null},ae=e=>e.article.content,ne=e=>e.article.state==="草稿",ie=()=>{const e=R(),r=i(re),[s]=u.useForm();o.useEffect(()=>{s.setFieldsValue(r)},[r,s]);const a=c=>{J(c)},n=()=>{m()};return t.jsx(t.Fragment,{children:t.jsxs(u,{style:{maxWidth:600},labelCol:{span:4},wrapperCol:{span:16},initialValues:r,onValuesChange:a,onFinish:n,form:s,children:[t.jsx(o.Suspense,{fallback:t.jsx(u.Item,{label:"文章标题",rules:[{required:!0,message:"请输入文章标题"}],children:t.jsx(g,{placeholder:"请输入文章标题",suffix:t.jsx(E,{style:{color:"#d3d3d3",fontSize:12}})})}),children:t.jsx(j,{resolve:e.flag,children:()=>t.jsx(u.Item,{name:"title",label:"文章标题",rules:[{required:!0,message:"请输入文章标题"}],children:t.jsx(g,{placeholder:"请输入文章标题",maxLength:30,allowClear:!0,showCount:!0})})})}),t.jsx(o.Suspense,{fallback:t.jsx(u.Item,{label:"文章分类",rules:[{required:!0,message:"请选择文章分类"}],children:t.jsx(y,{placeholder:"请选择文章分类",options:[],loading:!0})}),children:t.jsx(j,{resolve:e.cates,children:c=>t.jsxs(t.Fragment,{children:[t.jsx(u.Item,{name:"cate_id",label:"文章分类",rules:[{required:!0,message:"请选择文章分类"}],children:t.jsx(y,{placeholder:"请选择文章分类",options:c.data,fieldNames:{label:"cate_name",value:"id"}})}),t.jsx(u.Item,{wrapperCol:{offset:4},children:t.jsx(l,{type:"primary",htmlType:"submit",children:"下一步"})})]})})})]})})},ce=()=>{const e=i(se),r=o.useRef(null),s=n=>{const c=n.currentTarget.files;if(!(!c||c.length===0)){if(c[0].size>2*1024*1024)return p.error("封面图片大小不能超过2M！");X(c[0])}},a=()=>{if(!e)return p.error("请选择文章封面！");m()};return t.jsxs(f,{direction:"vertical",children:[e?t.jsx(C,{size:300,shape:"square",src:e}):t.jsx(C,{size:300,shape:"square",children:"请选择文章封面"}),t.jsxs(f,{direction:"horizontal",children:[t.jsx(l,{type:"primary",onClick:()=>m(x.prev),children:"上一步"}),t.jsx(l,{type:"primary",onClick:()=>{var n;return(n=r.current)==null?void 0:n.click()},children:"选择封面"}),t.jsx(l,{type:"primary",onClick:a,children:"下一步"}),t.jsx("input",{type:"file",accept:"image/*",style:{display:"none"},ref:r,onChange:s})]})]})},oe=()=>{const e=i(ae),r=w(),s=W("PUT"),a=o.useRef(i(ne)),n=c=>{if(!e||e==="<p><br></p>")return p.error("请填写文章的内容！");ee(c),r(null,{method:"PUT",navigate:!1})};return t.jsx("div",{className:B.artContent,children:t.jsx(Z,{spinning:s,delay:200,children:t.jsxs(f,{direction:"vertical",children:[t.jsx(U,{onChange:Y,theme:"snow",value:e,modules:q}),t.jsxs(f,{direction:"horizontal",children:[t.jsx(l,{type:"primary",onClick:()=>m(x.prev),children:"上一步"}),t.jsx(l,{type:"primary",onClick:()=>n("草稿"),style:{display:a.current?"":"none"},children:"存为草稿"}),t.jsx(l,{type:"primary",onClick:()=>n("已发布"),children:"发布"})]})]})})})},le=({value:e,prefix:r,suffix:s,onFinish:a})=>{const[n,c]=o.useState(e),h=o.useRef();return o.useEffect(()=>(h.current=setInterval(()=>{c(v=>v-1)},1e3),()=>{clearInterval(h.current)}),[]),o.useEffect(()=>{n===0&&(clearInterval(h.current),a&&a())},[n]),t.jsxs(t.Fragment,{children:[r,n,s]})},ue=()=>{const e=F(),r=I(),s=()=>{e("/art-list"+r.state)};return t.jsx(z,{status:"success",title:"修改成功！",subTitle:t.jsx(le,{value:5,suffix:"秒后自动跳转至文章列表页",onFinish:s}),extra:t.jsx(l,{type:"primary",onClick:()=>s(),children:"去文章列表页"})})},Fe=()=>{const e=i(te);L(o.useCallback(a=>{a.preventDefault()},[]));const r=D(({currentLocation:a,nextLocation:n})=>a.pathname!==n.pathname&&e!==d.done),s=o.useRef();return o.useEffect(()=>{if(r.state==="blocked"){if(s.current)return;s.current=$.confirm({title:"温馨提示",content:"您所做的更改将会丢失，是否确认离开当前页面？",okText:"确认离开",cancelText:"取消",onOk(){r.proceed()},onCancel(){r.reset(),s.current=null}})}}),t.jsxs("div",{children:[t.jsx(M,{items:N,current:e,size:"small"}),t.jsxs("div",{style:{marginTop:20},children:[e===d.base&&t.jsx(ie,{}),e===d.cover&&t.jsx(ce,{}),e===d.content&&t.jsx(oe,{}),e===d.done&&t.jsx(ue,{})]})]})},Ie=async({params:e})=>{const r=H(e.id),s=Q();return K(),T({flag:r,cates:s})},ze=async()=>{const e=i.getState().article,r=["id","title","cate_id","content","state","cover_img"],s=new FormData;r.forEach(a=>{s.append(a,e[a])});try{await O(s)}catch{return null}return p.success("修改成功"),m(),null};export{ze as action,Fe as default,Ie as loader};
