import{l as x,n as f,o as j,p as v,k as y,j as t,A as C,b,i as S,q as A,w as k}from"../entry/index-z2ldqZB7.js";import{a as R}from"./article-api-jngkzcRB.js";import{g as _}from"./cate-api-8TfO8f7V.js";import{u as w}from"./hooks-B1h-UHW-.js";import{_ as B}from"./warning-9o34qDdD.js";import{A as F}from"./AntdIcon-bP-MOnYo.js";var I={icon:{tag:"svg",attrs:{viewBox:"64 64 896 896",focusable:"false"},children:[{tag:"defs",attrs:{},children:[{tag:"style",attrs:{}}]},{tag:"path",attrs:{d:"M899.1 869.6l-53-305.6H864c14.4 0 26-11.6 26-26V346c0-14.4-11.6-26-26-26H618V138c0-14.4-11.6-26-26-26H432c-14.4 0-26 11.6-26 26v182H160c-14.4 0-26 11.6-26 26v192c0 14.4 11.6 26 26 26h17.9l-53 305.6a25.95 25.95 0 0025.6 30.4h723c1.5 0 3-.1 4.4-.4a25.88 25.88 0 0021.2-30zM204 390h272V182h72v208h272v104H204V390zm468 440V674c0-4.4-3.6-8-8-8h-48c-4.4 0-8 3.6-8 8v156H416V674c0-4.4-3.6-8-8-8h-48c-4.4 0-8 3.6-8 8v156H202.8l45.1-260H776l45.1 260H672z"}}]},name:"clear",theme:"outlined"};const H=I;var z=function(r,n){return React.createElement(F,B({},r,{ref:n,icon:H}))};const O=React.forwardRef(z);localforage.config({name:"article-admin"});const m=localforage,V=()=>({getItem(r){return m.getItem(r)},setItem(r,n){m.setItem(r,n)},removeItem(r){m.removeItem(r)}});var d=(e=>(e[e.next=1]="next",e[e.prev=-1]="prev",e))(d||{}),l=(e=>(e[e.base=0]="base",e[e.cover=1]="cover",e[e.content=2]="content",e[e.done=3]="done",e))(l||{});const L={current:0,article:{},_hasHydrated:!1},c=x()(f(j(v(()=>({...L}),{name:"art-add-store",storage:V(),onRehydrateStorage:()=>()=>{c.setState(e=>{e._hasHydrated=!0})}}),{name:"art-add-store"}))),i=c,u=(e=1)=>{c.setState(r=>{r.current+=e})},T=e=>{c.setState(r=>{r.article={...r.article,...e}})},q=e=>{c.setState(r=>{r.article.cover_img=e})},D=e=>{c.setState(r=>{r.article.content=e})},N=e=>{c.setState(r=>{r.article.state=e})},p=()=>{c.setState(e=>{e.article={}})},h=()=>{c.setState(e=>{e.current=0})},E=e=>e.current,$=e=>({title:e.article.title,cate_id:e.article.cate_id}),M=e=>{const r=e.article.cover_img;return r?URL.createObjectURL(r):null},P=e=>e._hasHydrated,U=e=>e.article.content,Q=()=>{const e=y(),r=i($),[n]=antd.Form.useForm();React.useLayoutEffect(()=>{n.setFieldsValue(r)},[r,n]);const a=s=>{u(d.next)},o=s=>{T(s)};return t.jsx("div",{children:t.jsxs(antd.Form,{style:{maxWidth:600},labelCol:{span:4},wrapperCol:{span:16},onFinish:a,form:n,onValuesChange:o,children:[t.jsx(antd.Form.Item,{label:"文章标题",name:"title",rules:[{required:!0,message:"请输入文章标题"}],children:t.jsx(antd.Input,{placeholder:"请输入文章标题",maxLength:30,showCount:!0,allowClear:!0})}),t.jsx(React.Suspense,{fallback:t.jsx(antd.Form.Item,{label:"文章分类",rules:[{required:!0,message:"请选择文章分类"}],children:t.jsx(antd.Select,{placeholder:"请选择文章分类",options:[],loading:!0})}),children:t.jsx(C,{resolve:e.result,children:s=>t.jsxs(t.Fragment,{children:[t.jsx(antd.Form.Item,{label:"文章分类",name:"cate_id",rules:[{required:!0,message:"请选择文章分类"}],children:t.jsx(antd.Select,{options:s.data,placeholder:"请选择文章分类",allowClear:!0,fieldNames:{label:"cate_name",value:"id"}})}),t.jsx(antd.Form.Item,{wrapperCol:{offset:4},children:t.jsx(antd.Button,{type:"primary",htmlType:"submit",children:"下一步"})})]})})})]})})},W="_art-content_1mffr_1",G={artContent:W},J={toolbar:[["bold","italic","underline","strike"],["blockquote","code-block"],["link","image","video","formula"],[{header:1},{header:2}],[{list:"ordered"},{list:"bullet"},{list:"check"}],[{script:"sub"},{script:"super"}],[{indent:"-1"},{indent:"+1"}],[{direction:"rtl"}],[{size:["small",!1,"large","huge"]}],[{header:[1,2,3,4,5,6,!1]}],[{color:[]},{background:[]}],[{font:[]}],[{align:[]}],["clean"]]},K=()=>{const e=i(U),r=b(),n=w("POST"),a=o=>{if(!e||e==="<p><br></p>")return antd.message.error("请填写文章的内容！");N(o),r(null,{method:"POST"})};return t.jsx("div",{className:G.artContent,children:t.jsx(antd.Spin,{spinning:n,delay:200,children:t.jsxs(antd.Space,{direction:"vertical",style:{display:"flex"},children:[t.jsx(ReactQuill,{theme:"snow",value:e,onChange:D,modules:J}),t.jsxs(antd.Space,{direction:"horizontal",children:[t.jsx(antd.Button,{type:"primary",onClick:()=>{u(d.prev)},children:"上一步"}),t.jsx(antd.Button,{type:"primary",onClick:()=>a("草稿"),children:"存为草稿"}),t.jsx(antd.Button,{type:"primary",onClick:()=>a("已发布"),children:"下一步"})]})]})})})},X=()=>{const e=React.useRef(null),r=i(M),n=o=>{const s=o.currentTarget.files;if(!(!s||s.length===0)){if(s[0].size>2*1024*1024)return antd.message.error("封面图片大小不能超过2M！");q(s[0])}},a=()=>{if(!r)return antd.message.error("请选择文章封面！");u(d.next)};return t.jsxs(antd.Space,{direction:"vertical",children:[r?t.jsx(antd.Avatar,{size:300,shape:"square",src:r}):t.jsx(antd.Avatar,{size:300,shape:"square",children:"请选择文章封面"}),t.jsxs(antd.Space,{direction:"horizontal",children:[t.jsx(antd.Button,{type:"primary",onClick:()=>{u(d.prev)},children:"上一步"}),t.jsx(antd.Button,{type:"primary",onClick:()=>{var o;return(o=e.current)==null?void 0:o.click()},children:"选择封面"}),t.jsx(antd.Button,{type:"primary",onClick:a,children:"下一步"}),t.jsx("input",{type:"file",accept:"image/*",ref:e,style:{display:"none"},onChange:n})]})]})},Y=()=>{const e=S(),r=A(),n=()=>{e("/art-list"),h()};return t.jsx("div",{children:t.jsx(antd.Result,{status:"success",title:r?r.msg:"文章发表成功！",extra:[t.jsx(antd.Button,{type:"primary",onClick:n,children:"去文章列表"},"list"),t.jsx(antd.Button,{onClick:()=>h(),children:"再写一篇"},"rewrite")]})})},g=[{title:"基本信息"},{title:"文章封面"},{title:"文章内容"},{title:"Done"}],Z=()=>{const e=i(E),r=i(P),n=React.useRef();React.useEffect(()=>()=>n.current&&n.current(),[]);const a=()=>{n.current=antd.Modal.confirm({title:"确认清空表单？",content:"此操作会清空表单中填写的所有数据，确认清空吗？",okText:"确认",cancelText:"取消",onOk:()=>{p(),h(),antd.message.success("表单清空完毕！")}}).destroy};return r&&t.jsxs("div",{children:[t.jsx(antd.Steps,{items:g,current:e,size:"small"}),t.jsxs("div",{style:{marginTop:20},children:[e===l.base&&t.jsx(Q,{}),e===l.cover&&t.jsx(X,{}),e===l.content&&t.jsx(K,{}),e===l.done&&t.jsx(Y,{})]}),t.jsx(antd.FloatButton,{type:"primary",tooltip:"清空表单",onClick:a,icon:t.jsx(O,{})})]})},ee=async()=>{const e=await m.getItem("art-add-store");(e==null?void 0:e.state.current)===l.done&&h();const n=_();return k({result:n})},te=async()=>{const e=i.getState().article,r=new FormData;for(const a in e)r.append(a,e[a]);try{await R(r)}catch{return null}u();const n=e.state==="草稿"?"草稿保存成功！":"文章发表成功！";return antd.message.success(n),p(),{msg:n}},le=Object.freeze(Object.defineProperty({__proto__:null,action:te,default:Z,loader:ee,stepItems:g},Symbol.toStringTag,{value:"Module"}));export{l as A,d as M,g as a,le as b,V as c,J as m,G as s};
