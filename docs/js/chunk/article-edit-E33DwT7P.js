import{l as f,n as h,o as x,p as g,k as j,j as t,A as m,b as v,i as y,d as C,x as R,y as S,w as b}from"../entry/index-poDKF_yo.js";import{A as o,c as A,M as u,s as k,m as F,a as w}from"./article-add-1RL6Vv4w.js";import{g as B,p as E}from"./article-api-P-la8WhL.js";import{c as L}from"./index-94wIOjEc.js";import{_ as I}from"./warning-TWdzD0xt.js";import{A as _}from"./AntdIcon-UAtldNpi.js";import{g as z}from"./cate-api-mVXEvP3J.js";import{u as T}from"./hooks-PobqOnIT.js";var D={icon:{tag:"svg",attrs:{viewBox:"0 0 1024 1024",focusable:"false"},children:[{tag:"path",attrs:{d:"M988 548c-19.9 0-36-16.1-36-36 0-59.4-11.6-117-34.6-171.3a440.45 440.45 0 00-94.3-139.9 437.71 437.71 0 00-139.9-94.3C629 83.6 571.4 72 512 72c-19.9 0-36-16.1-36-36s16.1-36 36-36c69.1 0 136.2 13.5 199.3 40.3C772.3 66 827 103 874 150c47 47 83.9 101.8 109.7 162.7 26.7 63.1 40.2 130.2 40.2 199.3.1 19.9-16 36-35.9 36z"}}]},name:"loading",theme:"outlined"};const O=D;var q=function(r,n){return React.createElement(_,I({},r,{ref:n,icon:O}))};const U=React.forwardRef(q),M={article:{},current:o.base},c=f()(h(x(g(()=>({...M}),{name:"art-edit-store",storage:A(),partialize(e){return{article:e.article}}}),{name:"art-edit-store"}))),N=async e=>{try{const r=await B(e);c.setState(n=>{r.data&&(n.article=r.data)})}catch{return null}return!0},V=e=>{c.setState(r=>{r.article={...r.article,...e}})},l=(e=u.next)=>{c.setState(r=>{r.current+=e})},P=()=>{c.setState(e=>{e.current=o.base})},$=e=>{c.setState(r=>{r.article.cover_img=e})},Q=e=>{c.setState(r=>{r.article.content=e})},W=e=>{c.setState(r=>{r.article.state=e})},G=e=>e.current,H=e=>({title:e.article.title,cate_id:e.article.cate_id}),J=e=>{const r=e.article.cover_img;return r?typeof r=="string"?L.baseURL+r:URL.createObjectURL(r):null},K=e=>e.article.content,X=e=>e.article.state==="草稿",Y=()=>{const e=j(),r=c(H),[n]=antd.Form.useForm();React.useEffect(()=>{n.setFieldsValue(r)},[r,n]);const a=i=>{V(i)},s=()=>{l()};return t.jsx(t.Fragment,{children:t.jsxs(antd.Form,{style:{maxWidth:600},labelCol:{span:4},wrapperCol:{span:16},initialValues:r,onValuesChange:a,onFinish:s,form:n,children:[t.jsx(React.Suspense,{fallback:t.jsx(antd.Form.Item,{label:"文章标题",rules:[{required:!0,message:"请输入文章标题"}],children:t.jsx(antd.Input,{placeholder:"请输入文章标题",suffix:t.jsx(U,{style:{color:"#d3d3d3",fontSize:12}})})}),children:t.jsx(m,{resolve:e.flag,children:()=>t.jsx(antd.Form.Item,{name:"title",label:"文章标题",rules:[{required:!0,message:"请输入文章标题"}],children:t.jsx(antd.Input,{placeholder:"请输入文章标题",maxLength:30,allowClear:!0,showCount:!0})})})}),t.jsx(React.Suspense,{fallback:t.jsx(antd.Form.Item,{label:"文章分类",rules:[{required:!0,message:"请选择文章分类"}],children:t.jsx(antd.Select,{placeholder:"请选择文章分类",options:[],loading:!0})}),children:t.jsx(m,{resolve:e.cates,children:i=>t.jsxs(t.Fragment,{children:[t.jsx(antd.Form.Item,{name:"cate_id",label:"文章分类",rules:[{required:!0,message:"请选择文章分类"}],children:t.jsx(antd.Select,{placeholder:"请选择文章分类",options:i.data,fieldNames:{label:"cate_name",value:"id"}})}),t.jsx(antd.Form.Item,{wrapperCol:{offset:4},children:t.jsx(antd.Button,{type:"primary",htmlType:"submit",children:"下一步"})})]})})})]})})},Z=()=>{const e=c(J),r=React.useRef(null),n=s=>{const i=s.currentTarget.files;if(!(!i||i.length===0)){if(i[0].size>2*1024*1024)return antd.message.error("封面图片大小不能超过2M！");$(i[0])}},a=()=>{if(!e)return antd.message.error("请选择文章封面！");l()};return t.jsxs(antd.Space,{direction:"vertical",children:[e?t.jsx(antd.Avatar,{size:300,shape:"square",src:e}):t.jsx(antd.Avatar,{size:300,shape:"square",children:"请选择文章封面"}),t.jsxs(antd.Space,{direction:"horizontal",children:[t.jsx(antd.Button,{type:"primary",onClick:()=>l(u.prev),children:"上一步"}),t.jsx(antd.Button,{type:"primary",onClick:()=>{var s;return(s=r.current)==null?void 0:s.click()},children:"选择封面"}),t.jsx(antd.Button,{type:"primary",onClick:a,children:"下一步"}),t.jsx("input",{type:"file",accept:"image/*",style:{display:"none"},ref:r,onChange:n})]})]})},ee=()=>{const e=c(K),r=v(),n=T("PUT"),a=React.useRef(c(X)),s=i=>{if(!e||e==="<p><br></p>")return antd.message.error("请填写文章的内容！");W(i),r(null,{method:"PUT",navigate:!1})};return t.jsx("div",{className:k.artContent,children:t.jsx(antd.Spin,{spinning:n,delay:200,children:t.jsxs(antd.Space,{direction:"vertical",children:[t.jsx(ReactQuill,{onChange:Q,theme:"snow",value:e,modules:F}),t.jsxs(antd.Space,{direction:"horizontal",children:[t.jsx(antd.Button,{type:"primary",onClick:()=>l(u.prev),children:"上一步"}),t.jsx(antd.Button,{type:"primary",onClick:()=>s("草稿"),style:{display:a.current?"":"none"},children:"存为草稿"}),t.jsx(antd.Button,{type:"primary",onClick:()=>s("已发布"),children:"发布"})]})]})})})},te=({value:e,prefix:r,suffix:n,onFinish:a})=>{const[s,i]=React.useState(e),d=React.useRef();return React.useEffect(()=>(d.current=setInterval(()=>{i(p=>p-1)},1e3),()=>{clearInterval(d.current)}),[]),React.useEffect(()=>{s===0&&(clearInterval(d.current),a&&a())},[s]),t.jsxs(t.Fragment,{children:[r,s,n]})},re=()=>{const e=y(),r=C(),n=()=>{e("/art-list"+r.state)};return t.jsx(antd.Result,{status:"success",title:"修改成功！",subTitle:t.jsx(te,{value:5,suffix:"秒后自动跳转至文章列表页",onFinish:n}),extra:t.jsx(antd.Button,{type:"primary",onClick:()=>n(),children:"去文章列表页"})})},ue=()=>{const e=c(G);R(React.useCallback(a=>{a.preventDefault()},[]));const r=S(({currentLocation:a,nextLocation:s})=>a.pathname!==s.pathname&&e!==o.done),n=React.useRef();return React.useEffect(()=>{if(r.state==="blocked"){if(n.current)return;n.current=antd.Modal.confirm({title:"温馨提示",content:"您所做的更改将会丢失，是否确认离开当前页面？",okText:"确认离开",cancelText:"取消",onOk(){r.proceed()},onCancel(){r.reset(),n.current=null}})}}),t.jsxs("div",{children:[t.jsx(antd.Steps,{items:w,current:e,size:"small"}),t.jsxs("div",{style:{marginTop:20},children:[e===o.base&&t.jsx(Y,{}),e===o.cover&&t.jsx(Z,{}),e===o.content&&t.jsx(ee,{}),e===o.done&&t.jsx(re,{})]})]})},me=async({params:e})=>{const r=N(e.id),n=z();return P(),b({flag:r,cates:n})},pe=async()=>{const e=c.getState().article,r=["id","title","cate_id","content","state","cover_img"],n=new FormData;r.forEach(a=>{n.append(a,e[a])});try{await E(n)}catch{return null}return antd.message.success("修改成功"),l(),null};export{pe as action,ue as default,me as loader};
